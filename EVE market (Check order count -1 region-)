{"cells":[{"cell_type":"code","execution_count":1,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"vPexwA1NkA6H","outputId":"05966db0-e189-42a4-d430-75aa791b43b4","executionInfo":{"status":"ok","timestamp":1661598908993,"user_tz":-360,"elapsed":973254,"user":{"displayName":"Hasinur Rahman","userId":"10022733991562386804"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["Starting...\n","Collecting All ItemsID and Names...\n","\n","\n","-->Total items to Check: 43049\n","\n","Please wait a Moment...\n","-->Time Taken:  1.9198739051818847 m\n","\n","Making Final list with Threading...\n","-->Time Taken:  14.25671569108963 m \n","\n","\n","D O N E\n","-->Total Time Taken:  16.176594976584116 m \n","\n","\n","Total items after web Request:  43049\n","Final list:  918 \n","\n","\n"]}],"source":["import requests, concurrent.futures, time\n","from threading import Lock\n","import pandas as pd\n","import numpy as nm\n","\n","\n","\n","class Items:\n","  def __init__(self, itemIds, region = 10000002):\n","    \"\"\"\n","    Default Region: The Forge\n","    \"\"\"\n","    print(f'-->Total items to Check: {len(itemIds)}')\n","\n","    self.region = region\n","    self.itemIds = itemIds\n","    self.ItemInfoList = []\n","\n","    self.dfItemInfo = pd.DataFrame()\n","    # self.dfItemInfoList = []\n","\n","    self.HEADERS = ({'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.81 Safari/537.36',\n","                     'Accept-Language': 'en-US;q=0.9',\n","                     })\n","\n","\n","  # will run in Threads\n","  def ItemInfo(self, itemId):\n","    \"\"\"\n","    itemId = List of max len 200\n","    \"\"\"\n","\n","    idS = str(itemId)[1:-1].replace(\" \", \"\")\n","\n","    # NO Region\n","    # URL = f\"https://api.evemarketer.com/ec/marketstat/json?typeid={idS}\"\n","\n","    # With Region\n","    URL = f\"https://api.evemarketer.com/ec/marketstat/json?typeid={idS}&regionlimit={self.region}\"\n","\n","\n","    res = requests.get(URL, headers = self.HEADERS)\n","\n","    with lock:\n","      # print(res)\n","      # print(len(res.json()))\n","      # print(\"\\n\\n\")\n","      self.ItemInfoList.extend(res.json())\n","\n","\n","  def chunks(self, lst, n):\n","    \"\"\"Yield successive n-sized chunks from lst.\"\"\"\n","    for i in range(0, len(lst), n):\n","        yield lst[i:i + n]\n","\n","\n","  def runThreading(self, MAX_THREADS):\n","    itemIdsChunks = list(self.chunks(self.itemIds, 199))\n","\n","    threads = min(MAX_THREADS, len(itemIdsChunks))\n","    with concurrent.futures.ThreadPoolExecutor(max_workers=threads) as executor:\n","      executor.map(self.ItemInfo, itemIdsChunks)\n","\n","\n","  def runThreadingForFinalList(self, threads):\n","    with concurrent.futures.ThreadPoolExecutor(max_workers=threads) as executor:\n","      executor.map(self.makeItemInfoDF, self.ItemInfoList)\n","\n","\n","  # will run in Threads\n","  def makeItemInfoDF(self, itemInfoJSON):\n","    \"\"\"send Item info JSON from JSON list\"\"\"\n","\n","    a = itemInfoJSON\n","    ItemID = a['buy']['forQuery']['types'][0]\n","    # ItemName = dfTypeids.loc[dfTypeids['0'] == ItemID].values[0][1]\n","\n","    sellPercentile = a['sell']['fivePercent']\n","    sellMin = a['sell']['min']\n","    # sellAvg = a['sell']['wavg']\n","    buyPercentile = a['buy']['fivePercent']\n","    buyMax = a['buy']['max']\n","    # buyAvg = a['buy']['wavg']\n","\n","    # # Buy/Sell Avg Deff [wavg]\n","    # df = pd.Series([buyAvg, buyPercentile]).pct_change() * 100\n","    # # buyAvgDiff = format(df.values[1], \".3f\")\n","    # buyAvgDiff = df.values[1]\n","\n","    # if not sellAvg:\n","    #   return\n","    # df = pd.Series([sellAvg, sellPercentile]).pct_change() * 100\n","    # # sellAvgDiff = format(df.values[1], \".3f\")\n","    # sellAvgDiff = df.values[1]\n","\n","\n","    # # Percentile Diff\n","    # df = pd.Series([buyPercentile, sellPercentile]).pct_change() * 100\n","    # # percenDiff = format(df.values[1], \".3f\")\n","    # percenDiff = df.values[1]\n","\n","\n","\n","    # if nm.isfinite(percenDiff):\n","\n","    URL = f\"https://esi.evetech.net/latest/markets/{self.region}/history/?datasource=tranquility&type_id={ItemID}\"\n","\n","\n","    res = requests.get(URL, headers = self.HEADERS)\n","\n","\n","\n","    if res.ok and res.json():\n","\n","      m13 = res.json()[-13:]\n","\n","      # avgPrice13 = 0\n","      avgOrder13 = 0\n","      avgVolume13 = 0\n","      for m in m13:\n","        # avgPrice13 += m['average']\n","        avgOrder13 += m['order_count']\n","        avgVolume13 += m['volume']\n","\n","      if avgOrder13 <= 1:\n","        return\n","      # avg order count in 13 days\n","      avgOrder13 = avgOrder13/13\n","\n","      # Stop if Order count is less then 300/day\n","      # if avgOrder13 < 299:\n","      #   return\n","\n","\n","      # sell price avg last 13 day\n","      # avgPrice13 = format(avgPrice13/13, \".3f\")\n","\n","\n","\n","      # inc/dec last 13 day\n","      # priceDiff13 = m13[-1]['average'] - m13[0]['average']\n","      # priceDiff13 = format(priceDiff13, \".3f\")\n","\n","      # inc/dec last 13 day in Percent\n","      df = pd.Series([m13[0]['average'], m13[-1]['average']]).pct_change() * 100\n","      priceDiffPercnt13 = format(df.values[1], \".3f\")\n","\n","      \n","      # avg sell volume\n","      # avgVolume13 = format(avgVolume13/13, \".3f\")\n","      avgVolume13 = avgVolume13/13\n","\n","      # Latest date for market history\n","      latestDate = m['date']\n","\n","\n","      # getting Name And Volume with ItemID\n","      URL = f\"https://esi.evetech.net/latest/universe/types/{ItemID}/?datasource=tranquility&language=en\"\n","\n","      res = requests.get(URL, headers = self.HEADERS).json()\n","      \n","      ItemName = res['name']\n","      packaged_volume = res['packaged_volume']\n","      \n","\n","      # with lock:\n","      #   print(\"Before Dict\\n\")\n","      #   print(type(percenDiff))\n","      #   print(percenDiff)\n","      #   print(sellAvgDiff)\n","      #   print(buyAvgDiff)\n","      #   print(\"\\n\\n\\n\")\n","\n","      try:\n","        dict1 =  {\n","            'Item Name': ItemName,\n","            # 'Buy/Sell Diff (%)': round(percenDiff),\n","            'Order Count [13 days Avg]' : round(avgOrder13),\n","            'Items per Order [13 days Avg]' : round(float(avgVolume13)/float(avgOrder13)),\n","            'Total Sell Volume [13 days Avg]' : round(avgVolume13),  \n","            # 'Sell Avg Diff (%)': round(sellAvgDiff),\n","            # 'Buy Avg Diff (%)': round(buyAvgDiff),\n","            'Profit Per Unit [same region]': sellPercentile - buyPercentile,\n","            'Sell Percentile': sellPercentile,\n","            'Buy Percentile': buyPercentile,\n","            'Packaged Volume': packaged_volume,\n","            # 'Avg Price [13 days]' : avgPrice13,\n","            'Price Diff (%) [from 13 day]' : priceDiffPercnt13,\n","            # 'Price Diff [13 day]' : priceDiff13,\n","            'Sell Min': sellMin,\n","            'Buy Max': buyMax,\n","            'ItemID': format(ItemID, \".0f\"),\n","            'latest Date [Market History]' : 'D: ' + str(latestDate),\n","        }\n","      except Exception as e:\n","        with lock:\n","          # print(type(percenDiff))\n","          # print(percenDiff)\n","          print(avgOrder13)\n","          print(avgVolume13)\n","          # print(sellAvgDiff)\n","          # print(buyAvgDiff)\n","          print(e)\n","          print(ItemName, \"\\n\\n\")\n","\n","          # print( e, \"\\nDict failed\")\n","\n","\n","      # with lock:\n","      #   print(\"After Dict\\n\")\n","      with lock:\n","        # print(\"self.dfItemInfoList.append(dict)\")\n","        # self.dfItemInfoList.append(dict1)\n","        self.dfItemInfo = self.dfItemInfo.append(dict1, ignore_index = True)\n","        \n","\n","\n","\n","\n","\n","  def start(self, evemerketerThreads = 99, evetechThreads = 99):\n","    \"\"\"Default Thread count 99 for All\"\"\"\n","\n","    t0 = time.time()\n","    print(\"\\nPlease wait a Moment...\")\n","    self.runThreading(evemerketerThreads)\n","    print(\"-->Time Taken: \", (time.time() - t0)/60,'m')\n","\n","\n","    t1 = time.time()\n","    print(\"\\nMaking Final list with Threading...\")\n","    self.runThreadingForFinalList(evetechThreads)\n","\n","    print(\"-->Time Taken: \", (time.time() - t1)/60,'m', '\\n\\n')\n","\n","    print(\"D O N E\")\n","    print(\"-->Total Time Taken: \", (time.time() - t0)/60,'m', '\\n\\n')\n","\n","    # return self.ItemInfoList\n","    # return self.ItemInfoList\n","    print(\"Total items after web Request: \", len(self.ItemInfoList))\n","    print(\"Final list: \", len(self.dfItemInfo), \"\\n\\n\")\n","    # print(\"dfItemInfoList: \", len(self.dfItemInfoList), '\\n\\n\\n')         \n","\n","\n","\n","# if __name__ == \"__main__\":\n","print(\"Starting...\")\n","\n","print(\"Collecting All ItemsID and Names...\\n\\n\")\n","\n","dfTypeids = pd.read_csv('http://www.fuzzwork.co.uk/resources/typeids.csv')\n","itemIds = list(dfTypeids['0'].values)\n","\n","\n","lock = Lock()\n","\n","# itemsInfo = Items(itemIds=itemIds[2000:2010])\n","\n","# itemsInfo = Items(itemIds=itemIds)\n","itemsInfo = Items(region = 10000060, itemIds=itemIds)\n","\n","itemsInfo.start(199, 37)\n","\n","# Region IDs\n","# The Forge = 10000002 (default)\n","# Delve = 10000060\n"]},{"cell_type":"code","execution_count":2,"metadata":{"id":"zK4yQcnXf5vU","executionInfo":{"status":"ok","timestamp":1661598908994,"user_tz":-360,"elapsed":8,"user":{"displayName":"Hasinur Rahman","userId":"10022733991562386804"}}},"outputs":[],"source":["# With Region\n","itemsInfo.dfItemInfo.to_csv(\"/content/drive/MyDrive/00_Sheets/EVE_OrderCount_Delve.csv\", encoding = \"utf-8\",  index=False)"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"aJIpP7KnxBKH"},"outputs":[],"source":["itemsInfo.dfItemInfo.tail()"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"5DaIZtdCpdsT"},"outputs":[],"source":["itemsInfo.dfItemInfo"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":3,"status":"ok","timestamp":1660657504372,"user":{"displayName":"Hasinur Rahman","userId":"10022733991562386804"},"user_tz":-360},"id":"O0Y8B27grFF3","outputId":"c31d16fb-c87d-4f98-cf70-a7b99d818b22"},"outputs":[{"data":{"text/plain":["0      NaN\n","1   -100.0\n","dtype: float64"]},"execution_count":11,"metadata":{},"output_type":"execute_result"}],"source":["df = pd.Series([10, 0]).pct_change() * 100\n","\n","# df.values[1]\n","df"]}],"metadata":{"colab":{"collapsed_sections":[],"name":"EVE market (Check order count [1 region])","provenance":[{"file_id":"1a4PXzYpXgvfEK6RVH8HepGAbyRFNHhlk","timestamp":1661528101928},{"file_id":"12_xNMb-aZriyqIsPyLmxWZkq00VBMcxP","timestamp":1658078997126},{"file_id":"1qJvQ2T-olHHBqot_b7m1LGSLF3P8lywc","timestamp":1658064075678}],"mount_file_id":"1-9h39_HtQNGBc9KEXZpcclPH9X4__6eg","authorship_tag":"ABX9TyOnoifdlSDYL+tEIfUtsVF+"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}